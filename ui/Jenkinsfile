pipeline{

     environment {
          name = 'impweb'
          registry='nexus-dev.securegion.com'
          registryport='18079'
          registryurl=''
          branch='2018.1'
           }
     agent any

     stages {

          stage('Clone') {
           when { branch ${branch}}
               steps{
                    echo 'getting code...'+env.BRANCH_NAME
                    checkout scm
               }
          }


          stage('Install') {
           when { branch ${branch}}
               steps{
                    sh 'sh install.sh'
                  
               }
          }

           stage('Build') {
           when { branch ${branch}}
               steps{
                    sh 'sh build.sh'
               }
          }

          stage("Packaging"){
            when { branch ${branch}}
            steps{
                echo 'preparing docker'
                sh 'docker build -t ${name} .'
                sh 'docker tag ${name} ${registry}:${registryport}/${name}'
            }
          }

          stage("Push dev registry"){
            when {branch ${branch}}
            steps{
                  sh 'docker push ${registry}:${registryport}/${name} '
            }
          }

           stage("Install on dev"){
                when {branch ${branch}}
                steps{
                   sh 'ssh root@dev docker pull ${registry}:${registryport}/${name} '
                   sh 'ssh root@dev docker rm -f ${name} || true'
                   sh 'ssh root@dev docker run --name ${name} -d -p 5001:80 ${registry}:${registryport}/${name} '
                }
             }

	}
}
